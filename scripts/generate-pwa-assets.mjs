import { spawnSync } from "node:child_process";
import { existsSync, mkdirSync, readFileSync, writeFileSync } from "node:fs";
import { dirname, resolve } from "node:path";
import { createRequire } from "node:module";

const root = process.cwd();
const inputIcon = resolve(root, "public/icon.png");
const iconOutputDir = resolve(root, "public/icons");
const splashOutputDir = resolve(root, "public/pwa");
const manifestPath = resolve(root, "public/manifest.json");
const htmlOut = resolve(root, "public/pwa/splash.html");
const startupLinksFile = resolve(root, "src/app/pwa-startup-images.tsx");

const splashPadding = "24%";
const iconPadding = "10%";
const splashBackground = "#b91c1c";
const iconBackground = "#b91c1c";

const iconArgs = [
  inputIcon,
  iconOutputDir,
  "--manifest",
  manifestPath,
  "--background",
  iconBackground,
  "--padding",
  iconPadding,
  "--icon-only",
  "--opaque",
  "--path-override",
  "/icons",
];

const splashArgs = [
  inputIcon,
  splashOutputDir,
  "--manifest",
  manifestPath,
  "--index",
  htmlOut,
  "--background",
  splashBackground,
  "--theme-color",
  "#a63038",
  "--padding",
  splashPadding,
  "--splash-only",
  "--opaque",
];

const require = createRequire(import.meta.url);
const pkgPath = require.resolve("pwa-asset-generator/package.json");
const pkg = JSON.parse(readFileSync(pkgPath, "utf8"));
const binPath =
  typeof pkg.bin === "string"
    ? resolve(dirname(pkgPath), pkg.bin)
    : resolve(dirname(pkgPath), pkg.bin["pwa-asset-generator"]);

if (!existsSync(splashOutputDir)) {
  mkdirSync(splashOutputDir, { recursive: true });
}

if (!existsSync(htmlOut)) {
  writeFileSync(
    htmlOut,
    "<!doctype html><html><head></head><body></body></html>",
    "utf8"
  );
}

const runGenerator = (args) => {
  const result = spawnSync(process.execPath, [binPath, ...args], {
    stdio: "inherit",
  });
  if (result.error) {
    console.error(result.error);
    process.exit(1);
  }
  if (result.status !== 0) {
    process.exit(result.status ?? 1);
  }
};

if (!existsSync(iconOutputDir)) {
  mkdirSync(iconOutputDir, { recursive: true });
}

runGenerator(iconArgs);
runGenerator(splashArgs);

if (!existsSync(htmlOut)) {
  console.warn("No splash HTML generated. Skipping startup image links update.");
  process.exit(0);
}

const html = readFileSync(htmlOut, "utf8");
const tags = html.match(/<link[^>]+apple-touch-startup-image[^>]*>/g) ?? [];

const links = tags
  .map((tag) => {
    const href = tag.match(/href=["']([^"']+)["']/)?.[1];
    const media = tag.match(/media=["']([^"']+)["']/)?.[1];
    if (!href || !media) return null;
    const normalizedHref =
      href.startsWith("/") || href.startsWith("http")
        ? href
        : `/pwa/${href}`;
    return { href: normalizedHref, media };
  })
  .filter(Boolean);

const linkLines = links
  .map(
    (link) =>
      `      <link rel="apple-touch-startup-image" href="${link.href}" media="${link.media}" />`
  )
  .join("\n");

const output = `// This file is auto-generated by scripts/generate-pwa-assets.mjs
// Run "npm run pwa:assets" after updating public/icon.png.
export function PwaStartupImages() {
  return (
    <>
${linkLines || "      {/* Startup images will be injected here. */}"}
    </>
  );
}
`;

writeFileSync(startupLinksFile, output, "utf8");
console.log(`Updated ${startupLinksFile}`);

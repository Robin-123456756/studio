import { spawnSync } from "node:child_process";
import { existsSync, mkdirSync, readFileSync, writeFileSync } from "node:fs";
import { dirname, resolve } from "node:path";
import { createRequire } from "node:module";

const root = process.cwd();
const inputIcon = resolve(root, "public/icon.png");
const blankSplashSource = resolve(root, "public/pwa/splash-source.png");
const outputDir = resolve(root, "public/pwa");
const manifestPath = resolve(root, "public/manifest.json");
const htmlOut = resolve(root, "public/pwa/splash.html");
const startupLinksFile = resolve(root, "src/app/pwa-startup-images.tsx");

const splashPadding = "24%";
const transparentPngBase64 =
  "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMBAF9p0WQAAAAASUVORK5CYII=";

if (!existsSync(blankSplashSource)) {
  writeFileSync(
    blankSplashSource,
    Buffer.from(transparentPngBase64, "base64")
  );
}

const splashSource = existsSync(blankSplashSource) ? blankSplashSource : inputIcon;

const args = [
  splashSource,
  outputDir,
  "--manifest",
  manifestPath,
  "--index",
  htmlOut,
  "--background",
  "#fbfaf9",
  "--theme-color",
  "#a63038",
  "--padding",
  splashPadding,
  "--splash-only",
  "--opaque",
];

const require = createRequire(import.meta.url);
const pkgPath = require.resolve("pwa-asset-generator/package.json");
const pkg = JSON.parse(readFileSync(pkgPath, "utf8"));
const binPath =
  typeof pkg.bin === "string"
    ? resolve(dirname(pkgPath), pkg.bin)
    : resolve(dirname(pkgPath), pkg.bin["pwa-asset-generator"]);

if (!existsSync(outputDir)) {
  mkdirSync(outputDir, { recursive: true });
}

if (!existsSync(htmlOut)) {
  writeFileSync(
    htmlOut,
    "<!doctype html><html><head></head><body></body></html>",
    "utf8"
  );
}

const result = spawnSync(process.execPath, [binPath, ...args], {
  stdio: "inherit",
});
if (result.error) {
  console.error(result.error);
  process.exit(1);
}
if (result.status !== 0) {
  process.exit(result.status ?? 1);
}

if (!existsSync(htmlOut)) {
  console.warn("No splash HTML generated. Skipping startup image links update.");
  process.exit(0);
}

const html = readFileSync(htmlOut, "utf8");
const tags = html.match(/<link[^>]+apple-touch-startup-image[^>]*>/g) ?? [];

const links = tags
  .map((tag) => {
    const href = tag.match(/href=["']([^"']+)["']/)?.[1];
    const media = tag.match(/media=["']([^"']+)["']/)?.[1];
    if (!href || !media) return null;
    const normalizedHref =
      href.startsWith("/") || href.startsWith("http")
        ? href
        : `/pwa/${href}`;
    return { href: normalizedHref, media };
  })
  .filter(Boolean);

const linkLines = links
  .map(
    (link) =>
      `      <link rel="apple-touch-startup-image" href="${link.href}" media="${link.media}" />`
  )
  .join("\n");

const output = `// This file is auto-generated by scripts/generate-pwa-assets.mjs
// Run "npm run pwa:assets" after updating public/icon.png.
export function PwaStartupImages() {
  return (
    <>
${linkLines || "      {/* Startup images will be injected here. */}"}
    </>
  );
}
`;

writeFileSync(startupLinksFile, output, "utf8");
console.log(`Updated ${startupLinksFile}`);
